
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A blog about selfhosting, unRAID and Linux ISOs">
      
      
        <meta name="author" content="GilbN">
      
      
        <link rel="canonical" href="https://docs.theme-park.dev/blog/cloudflare-fail2ban-integration-with-automated-set_real_ip_from-in-nginx/">
      
      <link rel="icon" href="../../site_assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.2">
    
    
      
        <title>How to setup Cloudflare and fail2ban with automated "set_real_ip_from" in nginx - technicalramblings.com</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f7951f6f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-setup-cloudflare-and-fail2ban-with-automated-set_real_ip_from-in-nginx" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://technicalramblings.com" title="technicalramblings.com" class="md-header__button md-logo" aria-label="technicalramblings.com" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            technicalramblings.com
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to setup Cloudflare and fail2ban with automated "set_real_ip_from" in nginx
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="light-green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/GilbN/technicalramblings.com/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    technicalramblings.com
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../my-unraid-server/" class="md-tabs__link md-tabs__link--active">
        Blog
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="/about" class="md-tabs__link">
      About
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="/discord" class="md-tabs__link">
      Support
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="/donate" class="md-tabs__link">
      Donate
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://technicalramblings.com" title="technicalramblings.com" class="md-nav__button md-logo" aria-label="technicalramblings.com" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    technicalramblings.com
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/GilbN/technicalramblings.com/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    technicalramblings.com
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Blog
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" data-md-state="indeterminate" type="checkbox" id="__nav_2_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Blog
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Blog" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../my-unraid-server/" class="md-nav__link">
        My unRAID Server
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" data-md-state="indeterminate" type="checkbox" id="__nav_2_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Backend
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Backend" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Backend
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../visualizing-nginx-geo-data-metrics-with-python-influxdb-and-grafana/" class="md-nav__link">
        Visualizing Nginx geo data metrics  with Python, InfluxDB and Grafana
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-route-different-metrics-in-telegraf-to-different-influx-databases/" class="md-nav__link">
        How to route metrics in Telegraf to different Influx databases
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring-your-ups-stats-and-cost-with-influxdb-and-grafana-on-unraid-telegraf-edition/" class="md-nav__link">
        Monitoring your UPS stats and cost with InfluxDB and Grafana on Unraid - Telegraf Edition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring-your-ups-stats-and-cost-with-influxdb-and-grafana-on-unraid-nut-edition/" class="md-nav__link">
        Monitoring your UPS stats and cost with InfluxDB and Grafana on Unraid - NUT Edition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring-your-ups-stats-and-cost-with-influxdb-and-grafana-on-unraid-2019-edition/" class="md-nav__link">
        Monitoring your UPS stats and cost with InfluxDB and Grafana on Unraid - Apcupsd Container Edition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-setup-grafana-influxdb-and-telegraf-to-monitor-your-unraid-system/" class="md-nav__link">
        How to setup Grafana, InfluxDB and Telegraf to monitor your unRAID system
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../migrating-view-history-between-two-plex-servers-avoiding-negative-unwatched-count/" class="md-nav__link">
        Migrating/Merging View History between two Plex Servers - Avoiding Negative Unwatched Count
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-setup-a-cloudflare-worker-to-show-a-maintenance-page-when-ca-backup-plugin-is-running/" class="md-nav__link">
        How to setup a Cloudflare worker to show a maintenance page when the CA Backup plugin is running on Unraid
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../optimizing-php-fpm-to-get-faster-load-times-of-tabs-in-organizr/" class="md-nav__link">
        Optimizing PHP-FPM to get faster load times of tabs in Organizr
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../remotely-accessing-the-unraid-gui-with-guacamole-and-vnc-web-browser/" class="md-nav__link">
        Remotely accessing the Unraid GUI with Guacamole and VNC Web Browser
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" data-md-state="indeterminate" type="checkbox" id="__nav_2_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Frontend
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Frontend" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Frontend
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-add-dark-mode-to-any-app-with-this-one-simple-trick/" class="md-nav__link">
        How to add dark mode to any app with this one simple trick!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-add-a-custom-login-page-for-unraid/" class="md-nav__link">
        How to add a custom login page for Unraid!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spice-up-your-homepage/" class="md-nav__link">
        Spice up your homepage!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spice-up-your-homepage-part-ii/" class="md-nav__link">
        Spice up your homepage Part II
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-setup-a-ghost-site-with-letsencrypt-and-mariadb-on-unraid/" class="md-nav__link">
        How to setup a Ghost blog on Unraid
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blocking-countries-with-geolite2-using-the-letsencrypt-docker-container/" class="md-nav__link">
        Blocking countries with GeoLite2 in nginx using the swag docker container
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-add-email-notifications-to-fail2ban/" class="md-nav__link">
        How to add email notifications to Fail2ban
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blocking-ssh-connections-with-the-geolite2-database/" class="md-nav__link">
        Blocking SSH Connections with the GeoLite2 Database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../adding-ban-unban-notifications-from-fail2ban-to-discord/" class="md-nav__link">
        Adding ban/unban notifications from Fail2Ban to Discord!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../adding-ban-unban-notifications-from-fail2ban-with-pushover/" class="md-nav__link">
        Adding ban/unban notifications from Fail2Ban to Pushover!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../redirecting-visitors-to-a-403-forbidden-page-when-accessing-the-wordpress-admin-page/" class="md-nav__link">
        Redirecting visitors to a 403 forbidden page when accessing the WordPress admin page
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howto-setup-gitlab-to-use-rack-attack-to-ban-abusive-ips/" class="md-nav__link">
        How to setup GitLab to use Rack Attack and ban abusive IPs and rate limit requests
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          How to setup Cloudflare and fail2ban with automated “set_real_ip_from” in nginx
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        How to setup Cloudflare and fail2ban with automated “set_real_ip_from” in nginx
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#adding-the-action" class="md-nav__link">
    Adding the action
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-jaillocal" class="md-nav__link">
    Updating jail.local
  </a>
  
    <nav class="md-nav" aria-label="Updating jail.local">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-specifying-which-site-the-ban-works-on" class="md-nav__link">
    Optional: Specifying which site the ban works on
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    Nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automatically-updating-the-cf_real-ipconf" class="md-nav__link">
    Automatically updating the cf_real-ip.conf
  </a>
  
    <nav class="md-nav" aria-label="Automatically updating the cf_real-ip.conf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-any-questions-you-can-find-me-here" class="md-nav__link">
    For any questions you can find me here
  </a>
  
    <nav class="md-nav" aria-label="For any questions you can find me here">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="/about" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="/discord" class="md-nav__link">
        Support
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="/donate" class="md-nav__link">
        Donate
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#adding-the-action" class="md-nav__link">
    Adding the action
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-jaillocal" class="md-nav__link">
    Updating jail.local
  </a>
  
    <nav class="md-nav" aria-label="Updating jail.local">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-specifying-which-site-the-ban-works-on" class="md-nav__link">
    Optional: Specifying which site the ban works on
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    Nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automatically-updating-the-cf_real-ipconf" class="md-nav__link">
    Automatically updating the cf_real-ip.conf
  </a>
  
    <nav class="md-nav" aria-label="Automatically updating the cf_real-ip.conf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-any-questions-you-can-find-me-here" class="md-nav__link">
    For any questions you can find me here
  </a>
  
    <nav class="md-nav" aria-label="For any questions you can find me here">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/GilbN/technicalramblings.com/edit/master/docs/blog/cloudflare-fail2ban-integration-with-automated-set_real_ip_from-in-nginx/index.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="how-to-setup-cloudflare-and-fail2ban-with-automated-set_real_ip_from-in-nginx">How to setup Cloudflare and fail2ban with automated "set_real_ip_from" in nginx<a class="headerlink" href="#how-to-setup-cloudflare-and-fail2ban-with-automated-set_real_ip_from-in-nginx" title="Permanent link">&para;</a></h1>
<p><small>Written: 2018-10-01</small></p>
<p><small>Tags</small></p>
<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">access</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">ban</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">cloudflare</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">fail2ban</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">letsencrypt</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">nginx</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">security</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">swag</a>
</p>

<p style="display:inline">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">unraid</a>
</p>

<p><small>Category</small></p>
<p style="display:inline;">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">backend</a>
</p>

<p style="display:inline;">
<a style="padding: .125em 1em; border-radius: 25px; margin-top:5px;" class="md-button md-button--primary" href="#">security</a>
</p>

<p><img src="images/Cloudflare-fail2ban-integration.jpg"></img></p>
<p>If you've decided to use cloudflare as a CDN you've might have noticed that fail2ban isn't working as expected. The fail2ban.log file will say that it has banned an IP, but since the connection is going through Cloudflare it will still let the banned IP browse your website. But luckily Cloudflare has an API we can use to update the Cloudflare firewall on the fly.</p>
<h2 id="adding-the-action">Adding the action<a class="headerlink" href="#adding-the-action" title="Permanent link">&para;</a></h2>
<p>If you've read my other <strong><a href="https://technicalramblings.com/?s=fail2ban">fail2ban</a></strong> guides you already know I'm using linuxservers swag container. So there won't be any walkthrough of installing fail2ban. I will only go through the cloudflare configuration.</p>
<p>Go to your appdata location and find the <strong><code>action.d</code></strong> folder <strong><code>appdata/swag/fail2ban/action.d</code></strong></p>
<p>In that folder there already is an action for cloudflare (<strong>cloudflare.conf</strong>) but that is using the deprecated API. Create a new file called <strong><code>cloudflare-apiv4.conf</code></strong> and add the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#</span>
<span class="c1"># Author: Gilbn from https://technicalramblings.com</span>
<span class="c1"># Adapted Source: https://github.com/fail2ban/fail2ban/blob/master/config/action.d/cloudflare.conf and https://guides.wp-bullet.com/integrate-fail2ban-cloudflare-api-v4-guide/</span>
<span class="c1">#</span>
<span class="c1"># To get your Cloudflare API key: https://dash.cloudflare.com/profile use the Global API Key</span>
<span class="c1">#</span>

<span class="o">[</span>Definition<span class="o">]</span>

<span class="c1"># Option:  actionstart</span>
<span class="c1"># Notes.:  command executed once at the start of Fail2Ban.</span>
<span class="c1"># Values:  CMD</span>
<span class="c1">#</span>
<span class="nv">actionstart</span> <span class="o">=</span>

<span class="c1"># Option:  actionstop</span>
<span class="c1"># Notes.:  command executed once at the end of Fail2Ban</span>
<span class="c1"># Values:  CMD</span>
<span class="c1">#</span>
<span class="nv">actionstop</span> <span class="o">=</span>

<span class="c1"># Option:  actioncheck</span>
<span class="c1"># Notes.:  command executed once before each actionban command</span>
<span class="c1"># Values:  CMD</span>
<span class="c1">#</span>
<span class="nv">actioncheck</span> <span class="o">=</span>

<span class="c1"># Option:  actionban</span>
<span class="c1"># Notes.:  command executed when banning an IP. Take care that the</span>
<span class="c1">#          command is executed with Fail2Ban user rights.</span>
<span class="c1"># Tags:      IP address</span>
<span class="c1">#            number of failures</span>
<span class="c1">#            unix timestamp of the ban time</span>
<span class="c1"># Values:  CMD</span>

<span class="nv">actionban</span> <span class="o">=</span> curl -s -X POST <span class="s2">&quot;https://api.cloudflare.com/client/v4/user/firewall/access_rules/rules&quot;</span> <span class="se">\</span>
            -H <span class="s2">&quot;X-Auth-Email: &lt;cfuser&gt;&quot;</span> <span class="se">\</span>
            -H <span class="s2">&quot;X-Auth-Key: &lt;cftoken&gt;&quot;</span> <span class="se">\</span>
            -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
            --data <span class="s1">&#39;{&quot;mode&quot;:&quot;block&quot;,&quot;configuration&quot;:{&quot;target&quot;:&quot;ip&quot;,&quot;value&quot;:&quot;&lt;ip&gt;&quot;},&quot;notes&quot;:&quot;Fail2ban &lt;name&gt;&quot;}&#39;</span>

<span class="c1"># Option:  actionunban</span>
<span class="c1"># Notes.:  command executed when unbanning an IP. Take care that the</span>
<span class="c1">#          command is executed with Fail2Ban user rights.</span>
<span class="c1"># Tags:      IP address</span>
<span class="c1">#            number of failures</span>
<span class="c1">#            unix timestamp of the ban time</span>
<span class="c1"># Values:  CMD</span>
<span class="c1">#</span>

<span class="nv">actionunban</span> <span class="o">=</span> curl -s -X DELETE <span class="s2">&quot;https://api.cloudflare.com/client/v4/user/firewall/access_rules/rules/</span><span class="k">$(</span> <span class="se">\</span>
              curl -s -X GET <span class="s2">&quot;https://api.cloudflare.com/client/v4/user/firewall/access_rules/rules?mode=block&amp;configuration_target=ip&amp;configuration_value=&lt;ip&gt;&amp;page=1&amp;per_page=1&amp;match=all&quot;</span> <span class="se">\</span>
             -H <span class="s2">&quot;X-Auth-Email: &lt;cfuser&gt;&quot;</span> <span class="se">\</span>
             -H <span class="s2">&quot;X-Auth-Key: &lt;cftoken&gt;&quot;</span> <span class="se">\</span>
             -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="p">|</span> awk -F<span class="s2">&quot;[,:}]&quot;</span> <span class="s1">&#39;{for(i=1;i&lt;=NF;i++){if($i~/&#39;</span>id<span class="s1">&#39;\042/){print $(i+1);}}}&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/^[ \t]*//&#39;</span> <span class="p">|</span> head -n <span class="m">1</span><span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
             -H <span class="s2">&quot;X-Auth-Email: &lt;cfuser&gt;&quot;</span> <span class="se">\</span>
             -H <span class="s2">&quot;X-Auth-Key: &lt;cftoken&gt;&quot;</span> <span class="se">\</span>
             -H <span class="s2">&quot;Content-Type: application/json&quot;</span>

<span class="o">[</span>Init<span class="o">]</span>

<span class="c1"># Name of the jail in your jail.local file. default = [jail name]</span>
<span class="nv">name</span> <span class="o">=</span> default

<span class="c1"># Option: cfuser</span>
<span class="c1"># Notes.: Replaces &lt;cfuser&gt; in actionban and actionunban with cfuser value below</span>
<span class="c1"># Values: Your CloudFlare user account</span>

<span class="nv">cfuser</span> <span class="o">=</span> user@mail.com

<span class="c1"># Option: cftoken (Global API Key)</span>
<span class="c1"># Notes.: Replaces &lt;cftoken&gt; in actionban and actionunban with cftoken value below</span>
<span class="c1"># Values: Your CloudFlare API key </span>
<span class="nv">cftoken</span> <span class="o">=</span> YOUR-API-KEY
</code></pre></div>
<p>The unban curl command from <a href="https://guides.wp-bullet.com/integrate-fail2ban-cloudflare-api-v4-guide/">https://guides.wp-bullet.com/integrate-fail2ban-cloudflare-api-v4-guide/</a> did not work for me but changing it to what this user on serverfault shared did<a href="https://serverfault.com/a/912547">https://serverfault.com/a/912547</a></p>
<p>At the end of the config file add your cloudflare email on the "<strong>cfuser</strong>" line and add your Cloudflare token on the "<strong>cftoken</strong>" line.</p>
<p>Your Cloudflare token can be found on your profile page. Use the "<strong>Global API Key</strong>"</p>
<p><a href="images/TqNz3ky.png"><img alt="" src="images/TqNz3ky.png" /></a></p>
<h2 id="updating-jaillocal">Updating jail.local<a class="headerlink" href="#updating-jaillocal" title="Permanent link">&para;</a></h2>
<p>Next is updating or adding your jails in the jail.local file. Go to your appdata location **<code>appdata/swag/fail2ban/</code>**and edit the file called jail.local. The only thing you really need to add is the action fail2ban will run after it has banned an IP.</p>
<p>Add <code>action = cloudflare-apiv4</code> in the jails you want to use it on. For me that would be all the jails.</p>
<div class="admonition error">
<p class="admonition-title">Default action!</p>
<p>If you only have the <strong><code>cloudflare</code></strong> action in the jail it will not update the iptables as it replaces the default action. You can add the action <strong><code>iptables-allports</code></strong> and it will then run both actions when banning</p>
</div>
<div class="highlight"><pre><span></span><code><span class="o">[</span>nginx-http-auth<span class="o">]</span>

<span class="nv">enabled</span>  <span class="o">=</span> <span class="nb">true</span>
<span class="nv">filter</span>   <span class="o">=</span> nginx-http-auth
<span class="nv">action</span>   <span class="o">=</span> cloudflare-apiv4
           iptables-allports
<span class="nv">port</span>     <span class="o">=</span> http,https
<span class="nv">logpath</span>  <span class="o">=</span> /config/log/nginx/error.log
<span class="nv">ignoreip</span> <span class="o">=</span> <span class="m">192</span>.168.1.0/24
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">[</span>organizrv2-auth<span class="o">]</span>

<span class="nv">enabled</span>  <span class="o">=</span> <span class="nb">true</span>
<span class="nv">filter</span>   <span class="o">=</span> organizrv2-auth
<span class="nv">action</span>   <span class="o">=</span> cloudflare-apiv4
           iptables-allports
<span class="nv">port</span>     <span class="o">=</span> http,https
<span class="nv">logpath</span>  <span class="o">=</span> /fail2ban/organizrLoginLog.json
<span class="nv">ignoreip</span> <span class="o">=</span> <span class="m">192</span>.168.1.0/24
</code></pre></div>
<h3 id="optional-specifying-which-site-the-ban-works-on">Optional: Specifying which site the ban works on<a class="headerlink" href="#optional-specifying-which-site-the-ban-works-on" title="Permanent link">&para;</a></h3>
<p>If you have several sites on your Cloudflare account and you want to specify which one the action should work on, you need to change the URL on the <strong>actionban</strong> line. Instead of <strong>user</strong> it needs to say <strong>zones</strong> and then your <strong>zone ID</strong>.</p>
<div class="highlight"><pre><span></span><code><span class="nv">actionban</span> <span class="o">=</span> curl -s -X POST <span class="s2">&quot;https://api.cloudflare.com/client/v4/zones/YOUR-CLOUDFLARE-ZONE-ID/firewall/access_rules/rules&quot;</span> <span class="se">\</span>
</code></pre></div>
<p>And the same on the <strong>actionunban</strong> line:</p>
<div class="highlight"><pre><span></span><code><span class="nv">actionunban</span> <span class="o">=</span> curl -s -X DELETE <span class="s2">&quot;https://api.cloudflare.com/client/v4/zones/YOUR-CLOUDFLARE-ZONE-ID/firewall/access_rules/rules/</span><span class="k">$(</span> <span class="se">\ </span>curl -s -X GET <span class="s2">&quot;https://api.cloudflare.com/client/v4/zones/YOUR-CLOUDFLARE-ZONE-ID/firewall/access_rules/rules?mode=block&amp;configuration_target=ip&amp;configuration_value=1.2.3.4&amp;page=1&amp;per_page=1&amp;match=all&quot;</span> <span class="se">\</span>
</code></pre></div>
<p>Your zone ID can be found on the overview page on Cloudflare.</p>
<p><a href="https://i.imgur.com/AMj7LuX.png"><img alt="" src="images/AMj7LuX.png" /></a></p>
<div class="admonition warning">
<p class="admonition-title">Whitelist</p>
<p>I recommend adding a whitelist on your WAN IP so you don't accidently ban yourself!</p>
</div>
<p>You can add the whitelist on Cloudflare by going to <strong>Firewall</strong> and then <strong>Tools.</strong> There you can add the access rule.</p>
<p><a href="https://technicalramblings.com/wp-content/uploads/2018/10/chrome_qckOhsyCxK.png"><img alt="" src="images/chrome_qckOhsyCxK-1024x639.png" /></a></p>
<h2 id="nginx">Nginx<a class="headerlink" href="#nginx" title="Permanent link">&para;</a></h2>
<p>Next up is configuring nginx so that it won't just ban the Cloudflare CDN IP but the actual IP of the visitor.</p>
<p>Add the following section to your <strong>http block</strong> in the <code>nginx.conf</code> file found in <strong><code>appdata/swag/nginx/</code></strong></p>
<div class="highlight"><pre><span></span><code><span class="k">set_real_ip_from</span> <span class="mi">103</span><span class="s">.21.244.0/22</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">103</span><span class="s">.22.200.0/22</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">103</span><span class="s">.31.4.0/22</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">104</span><span class="s">.16.0.0/12</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">108</span><span class="s">.162.192.0/18</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">131</span><span class="s">.0.72.0/22</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">141</span><span class="s">.101.64.0/18</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">162</span><span class="s">.158.0.0/15</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">172</span><span class="s">.64.0.0/13</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">173</span><span class="s">.245.48.0/20</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">188</span><span class="s">.114.96.0/20</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">190</span><span class="s">.93.240.0/20</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">197</span><span class="s">.234.240.0/22</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">198</span><span class="s">.41.128.0/17</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">2400</span><span class="p">:</span><span class="s">cb00::/32</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="n">2606</span><span class="p">:</span><span class="mi">4700</span><span class="p">::</span><span class="s">/32</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">2803</span><span class="p">:</span><span class="s">f800::/32</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="mi">2405</span><span class="p">:</span><span class="s">b500::/32</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="n">2405</span><span class="p">:</span><span class="mi">8100</span><span class="p">::</span><span class="s">/32</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="s">2c0f:f248::/32</span><span class="p">;</span>
<span class="k">set_real_ip_from</span> <span class="n">2a06</span><span class="p">:</span><span class="mi">98</span><span class="s">c0::/29</span><span class="p">;</span>

<span class="k">real_ip_header</span> <span class="s">X-Forwarded-For</span><span class="p">;</span>
</code></pre></div>
<p>The IP's are from these URLS: <a href="https://www.cloudflare.com/ips-v4">https://www.cloudflare.com/ips-v4</a></p>
<p><a href="https://www.cloudflare.com/ips-v6">https://www.cloudflare.com/ips-v6</a></p>
<p>You can set it up as an include like this too:</p>
<div class="highlight"><pre><span></span><code><span class="c1">##</span>
<span class="c1"># CF Real IP</span>
<span class="c1">##</span>
<span class="k">include</span> <span class="n">/config/nginx/cf_real-ip.conf</span>;
<span class="k">real_ip_header</span> <span class="s">X-Forwarded-For</span><span class="p">;</span>
</code></pre></div>
<p>After that you need to restart the swag container for the changes to take effect.</p>
<p>Next you can test that it actually works by using a vpn ect and ban yourself. Set bantime to 60 for it to only ban the IP for 1 minute. After the IP is banned you can see the new firewall rule on cloudflare dashboard.</p>
<p><a href="images/CHewDQu.png"><img alt="" src="images/CHewDQu.png" /></a></p>
<p>I've noticed that with the new API it is much faster in banning and unbanning IP's! When using the old API it could sometimes take up to 2 minutes for the rule to show in Cloudflare. Now it's there in a matter of seconds.</p>
<h2 id="automatically-updating-the-cf_real-ipconf">Automatically updating the cf_real-ip.conf<a class="headerlink" href="#automatically-updating-the-cf_real-ipconf" title="Permanent link">&para;</a></h2>
<p>Tronyx over at the discord forums graciously shared his script for updating the Cloudflare ip list. This list is not static and Cloudflare updates it once in a while.</p>
<p>The script below will update the list with any changes in the list of IPs from CF</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">printf</span> <span class="s2">&quot;set_real_ip_from %b;\n&quot;</span> <span class="k">$(</span><span class="o">{</span>
  curl -s -w <span class="s1">&#39;\n&#39;</span> <span class="s2">&quot;https://www.cloudflare.com/ips-v4&quot;</span> <span class="p">&amp;</span>
  curl -s -w <span class="s1">&#39;\n&#39;</span> <span class="s2">&quot;https://www.cloudflare.com/ips-v6&quot;</span> <span class="p">&amp;</span>
  ip route <span class="p">|</span> grep -v default <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span>
<span class="o">}</span><span class="k">)</span> &gt; /mnt/nvme/docker/swag/nginx/cf_real-ip.conf
</code></pre></div>
<p>I use unraid so I will use the User Scripts plugin to setup a cronjob that will run once a week.</p>
<ol>
<li>Go to Settings &gt; User Scripts and click <strong><code>Add New Script</code></strong></li>
<li>Give it a name and a description if you want</li>
<li>Click edit script and add it inside the box.</li>
<li>You will need to update the path in the last line to you nginx appdata folder</li>
<li>Set the schedule to weekly and click apply and done.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">printf</span> <span class="s2">&quot;set_real_ip_from %b;\n&quot;</span> <span class="k">$(</span><span class="o">{</span>
  curl -s -w <span class="s1">&#39;\n&#39;</span> <span class="s2">&quot;https://www.cloudflare.com/ips-v4&quot;</span> <span class="p">&amp;</span>
  curl -s -w <span class="s1">&#39;\n&#39;</span> <span class="s2">&quot;https://www.cloudflare.com/ips-v6&quot;</span> <span class="p">&amp;</span>
  ip route <span class="p">|</span> grep -v default <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span>
<span class="o">}</span><span class="k">)</span> &gt; /mnt/user/docker/swag/nginx/cf_real-ip.conf
</code></pre></div>
<h3 id="for-any-questions-you-can-find-me-here">For any questions you can find me here<a class="headerlink" href="#for-any-questions-you-can-find-me-here" title="Permanent link">&para;</a></h3>
<h4 id="_1"><a href="https://discordapp.com/invite/TrNtY7N"><img alt="Discord" src="https://img.shields.io/discord/591352397830553601.svg?color=6f83cc&amp;label=Discord&amp;logo=sd&amp;style=for-the-badge" /></a><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<p>Sources:</p>
<p><strong>Tronyx</strong> 😘 Thank you Tronyx for creating the first draft of the guide.</p>
<p><strong><a href="https://guides.wp-bullet.com/integrate-fail2ban-cloudflare-api-v4-guide">https://guides.wp-bullet.com/integrate-fail2ban-cloudflare-api-v4-guide</a></strong></p>
<p><strong><a href="https://serverfault.com/a/912547">https://serverfault.com/a/912547</a></strong></p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 18, 2021</span>
      
    
  </small>
</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../howto-setup-gitlab-to-use-rack-attack-to-ban-abusive-ips/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How to setup GitLab to use Rack Attack and ban abusive IPs and rate limit requests" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              How to setup GitLab to use Rack Attack and ban abusive IPs and rate limit requests
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://docs.theme-park.dev/donate" target="_blank" rel="noopener" title="Donate" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>
    </a>
  
    
    
    <a href="https://docs.theme-park.dev/discord" target="_blank" rel="noopener" title="Discord" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541zM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241z"/></svg>
    </a>
  
    
    
    <a href="https://github.com/users/GilbN/packages/container/package/theme.park" target="_blank" rel="noopener" title="Docker" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    <a href="https://github.com/gilbn" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.expand"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.0bbba5b5.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.649a939e.min.js"></script>
      
    
  </body>
</html>